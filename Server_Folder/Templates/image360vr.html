<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover">
  <title>{{.WS_Title}}</title>
  <style>
    html,body{height:100%;margin:0;background:#000;color:#fff;font-family:system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial}
    #container{width:100%;height:100%;position:relative;overflow:hidden}
    #ui{position:absolute;left:12px;top:12px;z-index:10}
    button{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);color:#fff;padding:8px 12px;border-radius:8px}
    #hint{position:absolute;left:12px;bottom:12px;font-size:13px;opacity:0.9}
    #credits{position:absolute;right:12px;bottom:12px;font-size:12px;opacity:0.7}
  </style>
</head>
<body>
  <div id="container"></div>
  <div id="ui">
    <button id="gyroBtn">ジャイロ有効にする</button>
    <button id="resetBtn">リセット</button>
  </div>
  <div id="hint">タップしてドラッグ／ピンチでズーム／スマホを動かして視点移動</div>

  <!-- three.js (esm build via unpkg) -->
  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
    import { OrbitControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js';
    import { DeviceOrientationControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/DeviceOrientationControls.js';

    const container = document.getElementById('container');
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0.01, 0, 0); // 少しずらす（球の中心にカメラ）

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    container.appendChild(renderer.domElement);

    // 球ジオメトリ（内向き）
    const geometry = new THREE.SphereGeometry(500, 60, 40);
    geometry.scale(-1, 1, 1); // 内側を向くよう反転

    // デフォルトのパノラマ画像（公開されているものを使わないようにプレースホルダ）
    // ユーザーは以下のURLを自分の360パノラマ(equirectangular)画像に置き換えてください。
    const textureURL = ' {{.WS_ImagePaths}}';

    const loader = new THREE.TextureLoader();
    const material = new THREE.MeshBasicMaterial({ map: loader.load(textureURL, () => { renderer.render(scene, camera); }) });
    const sphere = new THREE.Mesh(geometry, material);
    scene.add(sphere);

    // 操作：タッチ／マウス用 OrbitControls（常に有効）
    const orbit = new OrbitControls(camera, renderer.domElement);
    orbit.enablePan = false;
    orbit.rotateSpeed = 0.3;
    orbit.enableZoom = true;
    orbit.zoomSpeed = 1.0;
    orbit.enableDamping = true;
    orbit.dampingFactor = 0.08;
    orbit.minDistance = 0.01;
    orbit.maxDistance = 1000;

    // デバイスジャイロ用コントロール（必要に応じて有効化）
    const deviceControls = new DeviceOrientationControls(camera);
    let gyroEnabled = false;

    // iOSのDeviceOrientation権限要求をボタンで行う
    const gyroBtn = document.getElementById('gyroBtn');
    gyroBtn.addEventListener('click', async () => {
      // iOS 13+ の権限APIに対応
      if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
        try {
          const response = await DeviceMotionEvent.requestPermission();
          // DeviceMotionEvent.requestPermission()は'granted'を返す
          if (response === 'granted') {
            gyroEnabled = true;
            deviceControls.connect();
            gyroBtn.textContent = 'ジャイロ: 有効';
            gyroBtn.disabled = true;
          } else {
            alert('ジャイロの権限が拒否されました。設定を確認してください。');
          }
        } catch (err) {
          console.error(err);
          alert('ジャイロ権限の要求に失敗しました。');
        }
      } else if ('ondeviceorientationabsolute' in window || 'DeviceOrientationEvent' in window) {
        // Android やブラウザが許可不要の場合
        gyroEnabled = true;
        deviceControls.connect();
        gyroBtn.textContent = 'ジャイロ: 有効';
        gyroBtn.disabled = true;
      } else {
        alert('このデバイス／ブラウザはジャイロをサポートしていない可能性があります。');
      }
    });

    // リセットボタン
    document.getElementById('resetBtn').addEventListener('click', () => {
      // カメラ角度をリセット
      camera.position.set(0.01, 0, 0);
      camera.rotation.set(0, 0, 0);
      orbit.reset();
      if (gyroEnabled) deviceControls.connect();
    });

    // レンダーループ
    function animate() {
      requestAnimationFrame(animate);
      if (gyroEnabled) {
        deviceControls.update();
      } else {
        orbit.update();
      }
      renderer.render(scene, camera);
    }
    animate();

    // リサイズ対応
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // 重要な注意点（コンソールにも表示）
    console.log(`注意:
 - this HTML は HTTPS または localhost で提供する必要があります。\n - iOS (Safari) ではジャイロの権限をユーザー操作で許可する必要があります（[ジャイロ有効にする] ボタン）。\n - textureURL をあなたの360パノラマ画像に置き換えてください。`);
  </script>
</body>
</html>